{% extends "base.html" %}

{% block content %}

      <div id="app" class="container-fluid">
        <div class="row mx-5" style="height: 130vh">
          <div class="col-8 h-10 align-self-center">
            <h2>Plansza przeciwnika</h2>
            <table class="row border rounded visible h-20 w-20 m-auto" style="font-size: 1.2rem" ref="gameboard_main" @click="playerAction">
              <tr>
                <td class="h-100 pr-2 col border border-dark "></td>
                {% for i in range(1,9) %}<td class="h-100 pr-2 col border border-dark">{{i}}</td>{%endfor%}
              </tr>
              {% for i in range(1,9) %}
              <tr>
                <td class="h-100 pr-2 col border border-dark" >{{ alphabet[i-1]}}</td>
                {% for j in range(1,9) %}
                <td class="col pr-2 border border-dark" data-id="{{ i }}{{ j }}" ref="{{ i }}{{ j }}"></td>
                {%endfor%}
              </tr>
              {%endfor%}
            </table>
            <h2>Twoja plansza</h2>
            <table id="yourBoxes"  class="row border rounded visible h-20 w-20 m-auto" style="font-size: 1.2rem" ref="gameboard" @click="settingAction">
              <tr>
                <td class="h-100 pr-2 col border border-dark"></td>
                {% for i in range(1,9) %}<td class="h-100 pr-2 col border border-dark">{{i}}</td>{%endfor%}
              </tr>
              {% for i in range(1,9) %}
              <tr>
                <td class="h-100 pr-2 col border border-dark" >{{ alphabet[i-1]}}</td>
                {% for j in range(1,9) %}
                <td class="col pr-2 border border-dark" data-id="{{ i }}{{ j }}" ref="{{ i }}{{ j }}"></td>
                {%endfor%}
              </tr>
              {%endfor%}
            </table>
          </div>
          <div class="col-4 pl-3">
            <div class="row h-100">
              <div class="col border h-75 text-center" style="background: rgb(114, 230, 147);">
                <p class="my-3">HI,{% raw %} {{ username }} {% endraw %} !!</p>
                <p class="my-3"> {% raw %} {{ players }} {% endraw %} online player(s) </p>
                <hr/>
                <li class="m-auto py-3 text-dark" style="cursor: pointer;" v-for="member in connectedPlayers" @click="choosePlayer">
                  {% raw %} {{ member }} {% endraw %}
                </li>
              </div>
              <div class="w-100"></div>
              <div class="col text-center py-3 border h-25" @click="confirmSetup" style="cursor: pointer; background: #b6c0ca; font-size: 1em; font-weight: bold">
                {% raw %} {{ status }} {% endraw %}
              </div>
            </div>
          </div>
        </div>
      </div>

<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://js.pusher.com/4.2/pusher.min.js"></script>
<script>
 Pusher.logToConsole = true;
 var app = new Vue({
    el: '#app',

    data: {
    username: {{ name|tojson }},
    alphabet: {{ alphabet|tojson }},
    players: 0,
    connectedPlayers: [],
    status: '',
    ready: 0,
    opponentReady: 0,
    pusher: new Pusher('4d2726b6eaed69e2834f', {
        authEndpoint: '/pusher/auth',
        cluster: 'eu',
        encrypted: true
    }),
    otherPlayerName: '',
    mychannel: {},
    otherPlayerChannel: {},
    turn: 0,
    mainBoxes: [[0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0]],
    yourBoxes: [[0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0]]
    },

    created () {
      this.subscribe();
      this.listeners();
    },

    methods: {
        subscribe: function () {
            let channel = this.pusher.subscribe('presence-channel');
            this.myChannel = this.pusher.subscribe('private-' + this.username);
            channel.bind('pusher:subscription_succeeded', (player) => {
                this.players = player.count - 1;
                player.each((player) => {
                    if (player.id != this.username){
                      this.connectedPlayers.push(player.id);}
                });
            });
            channel.bind('pusher:member_added', (player) => {
                this.players++;
                this.connectedPlayers.push(player.id);
            });
            channel.bind('pusher:member_removed', (player) => {
                this.players--;
                var index = this.connectedPlayers.indexOf(player.id);
                if (index > -1) {
                  this.connectedPlayers.splice(index, 1)
                }
            });
        },

        listeners: function () {
            this.pusher.bind('client-' + this.username, (message) => {
                if (confirm(message + ' zaprasza cię do gry w statki')) {
                    this.otherPlayerName = message
                    this.otherPlayerChannel = this.pusher.subscribe('private-' + this.otherPlayerName)
                    this.otherPlayerChannel.bind('pusher:subscription_succeeded', () => {
                        this.otherPlayerChannel.trigger('client-set-ships', message)
                    })
                this.setShipsOnMap() //ETAP ROZSTAWIANIA STATKOW, DODAC WALIDACJE ROZSTAWIANIA I LIMITY
                } else {
                    this.otherPlayerChannel = this.pusher.subscribe('private-' + message)
                    this.otherPlayerChannel.bind('pusher:subscription_succeeded', () => {
                        this.otherPlayerChannel.trigger('client-game-declined', "")
                    })
                  this.gameDeclined()
                }
            }),

            this.myChannel.bind('client-game-started', (message) => {
                this.status = "Zaczynasz bitwe z  " + message
                this.turn = 1;
            })

            this.myChannel.bind('client-set-ships', (message) => {this.setShipsOnMap()})

            this.myChannel.bind('client-game-declined', () => {this.status = "Odmowa bitwy"})

            this.myChannel.bind('client-is-ready', () => {this.opponentReady = 1;})

            this.myChannel.bind('client-your-turn', () => {this.turn = 1;})

            this.myChannel.bind('client-box-update', (update) => {this.mainBoxes = update;})

            this.myChannel.bind('client-you-lost', () => {this.gameLost();})

            this.myChannel.bind('client-ask-position', (yPos, xPos) => {this.getValueOnPos(yPos, xPos);})

            this.myChannel.bind('client-return-value', (value) => {this.getValueFromOpponent(value);})
        },

        // Wyslanie zaproszenia do gry
        choosePlayer: function (e) {
            this.otherPlayerName = e.target.innerText
            this.otherPlayerChannel = this.pusher.subscribe('private-' + this.otherPlayerName)
            this.otherPlayerChannel.bind('pusher:subscription_succeeded', () => {
                this.otherPlayerChannel.trigger('client-' + this.otherPlayerName, this.username)
            });
        },

        // Potwierdz ulozenie planszy
        confirmSetup: function (e) {
            this.ready = 1
            if (this.opponentReady == 0){
                this.otherPlayerChannel.trigger('client-is-ready', "")
            } else{
                this.startGame()
                this.otherPlayerChannel.trigger('client-game-started', "")
            }
          },

        // Set ships on the map
        setShipsOnMap: function () {this.status = "Ustaw statki na planszy. Kliknij tutaj, gdy bedziesz gotowy "},

        // rozpoczecie gry
        startGame: function () {
            this.status = "Gra zaczeta ";
            //dorobic blokowanie yourBoxes!!!!!!
        },

        // Gracz odmowil rozgrywki
        gameDeclined: function () {this.status = "Nie przyjęto zaproszenia"},

        // Obecny gracz wygrywa
        gameWon: function () {
            this.status = "Wygrales!"
            this.restartGame()
        },

        // Obecny gracz przegrywa
        gameLost: function () {
            this.turn = 1;
            this.status = "Przegrales!"
            this.restartGame()
        },

        restartGame: function () {
            this.$refs.gameboard_main.classList.add('invisible');
            this.$refs.gameboard.classList.add('invisible');
                for (i = 1; i < 9; i++) {
                    for (j = 1; j < 9; j++) {
                       this.$refs[i][j].style.background  = 'white';
                       this.mainBoxes[i][j] = 0;
                       this.yourBoxes[i][j] = 0
                    }
                }
              this.$refs.gameboard_main.classList.remove('invisible');
              this.$refs.gameboard.classList.remove('invisible');
        },

        // sprawdza, czy wszystkie statki zostaly znalezione
        theresAMatch: function () {
            for (var i = 1; i < 9; i++) {
                for (var j = 1; j < 9; j++) {
                    if (this.mainBoxes[i][j] == 2) {  //POPRAWIC
                        return false
                    }
                }
            }
            return true
        },

        // Ustawianie statkow + Dodac walidacje rozstawiania
        settingAction: function (e) {
            let index = e.target.dataset.id
            let yPos = (Math.floor(index/10))-1
            let xPos = index%10 -1

            console.log(yPos + ' ' +xPos + " " + this.yourBoxes[yPos][xPos])
            if (this.yourBoxes[yPos][xPos] == 0) {
                this.yourBoxes[yPos][xPos] = 2
                e.target.style.background = 'black'
            } else if (this.yourBoxes[yPos][xPos] == 2) {
                this.yourBoxes[yPos][xPos] = 0
                e.target.style.background = 'white'
            }
        },

        getValueOnPos: function (yPos, xPos){
            var value = this.yourBoxes[yPos][xPos]
            this.otherPlayerChannel.trigger('client-return-value', value)
        },

        getValueFromOpponent: function (value){
            if (value == 2 ){
                this.mainBoxes[yPos][xPos] = 1
                this.$refs[yPos][xPos].style.background = 'green'
            } else {
                this.mainBoxes[yPos][xPos] = -1
                this.$refs[yPos][xPos].style.background = 'red'
                this.otherPlayerChannel.trigger('client-your-turn', "")
            }

            this.otherPlayerChannel.trigger('client-box-update', this.mainBoxes)
            if (this.theresAMatch()) {
                this.gameWon()
                this.otherPlayerChannel.trigger('client-you-lost', '')
            }
        },

        // Checks to see if the play was a winning play
        playerAction: function (e) {
            let index = e.target.dataset.id
            let yPos = (Math.floor(index/10))-1
            let xPos = index%10 -1

            if (this.turn && this.mainBoxes[yPos][xPos] == 0) {
                this.turn = 0
                this.otherPlayerChannel.trigger('client-ask-position', yPos, xPos)
            }
        },
    }
 });
</script>
{% endblock %}