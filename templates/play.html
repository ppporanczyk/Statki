{% extends "base.html" %}

{% block content %}
<div class="container-xl">
  <div id="app" class="container-xl">
    <div class="row mx-5" style="height: 100vh">
      <div class="col-8 h-10 ">

        <h2 class="p-4 w-75">Plansza przeciwnika</h2>
        <table class="row  rounded visible h-20 w-20 m-auto " style="font-size: 1.2rem;display:inline-block;" ref="gameboard_main"
          @click="playerAction">
          <tr>
            <td class="h-100 pr-2 col border border-dark "></td>
            {% for i in range(0,8) %}
            <td class="h-100 pr-2 col border border-dark">{{i+1}}</td>
            {%endfor%}
          </tr>
          {% for i in range(0,8) %}
          <tr>
            <td class="h-100 pr-2 col border border-dark">{{ alphabet[i]}}</td>
            {% for j in range(0,8) %}
            <td class="col pr-2 border border-dark" data-i="{{ i }}" data-j="{{ j }}"></td>
            {%endfor%}
          </tr>
          {%endfor%}
        </table>
        <!-- <div class="counterShips w-25 ml-5">
          <p>Licznik statkow do rozlozenia</p>
          <p>4-masztowce {% raw %} {{ ship4Len }}{% endraw %}</p>
          <p>3-masztowce {% raw %} {{ ship3Len }}{% endraw %}</p>
          <p>2-masztowce {% raw %} {{ ship2Len }}{% endraw %}</p>
          <p>1-masztowce {% raw %} {{ ship1Len }}{% endraw %}</p>
        </div> -->

        <table class="styled-table counterShips w-30 ml-5">
          <thead>
              <tr>
                  <th>Statki do rozłożenia</th>
                  <th>Ilosc</th>
              </tr>
          </thead>
          <tbody>
              <tr>
                  <td>4-masztowce</td>
                  <td>{% raw %} {{ ship4Len }}{% endraw %}</td>
              </tr>
              <tr>
                <td>3-masztowce</td>
                <td>{% raw %} {{ ship3Len }}{% endraw %}</td>
            </tr>
            <tr>
              <td>2-masztowce</td>
              <td>{% raw %} {{ ship2Len }}{% endraw %}</td>
          </tr>
          <tr>
            <td>1-masztowce</td>
            <td>{% raw %} {{ ship1Len }}{% endraw %}</td>
        </tr>
          </tbody>
      </table>
        <h2 class="p-4">Twoja plansza</h2>
        <table id="yourBoxes" class="row rounded visible h-20 w-20 m-auto" style="font-size: 1.2rem"
          ref="gameboard" @mouseout="selectInRange" @mousedown="selectFrom" @mouseup="selectTo" ><!--@click="settingAction"-->
          <tr>
            <td class="h-100 pr-2 col border border-dark"></td>
            {% for i in range(0,8) %}
            <td class="h-100 pr-2 col border border-dark">{{i+1}}</td>
            {%endfor%}
          </tr>
          {% for i in range(0,8) %}
          <tr>
            <td class="h-100 pr-2 col border border-dark">{{ alphabet[i]}}</td>
            {% for j in range(0,8) %}
            <td class="col pr-2 border border-dark" id="pos{{ i }}{{ j }}" data-i="{{ i }}" data-j="{{ j }}"></td>
            {%endfor%}
          </tr>
          {%endfor%}
        </table>
      </div>

      <div class="col-4 pl-3 playersList">
        <div class="row h-75">
          <div class="col h-75 text-center " style="background: rgb(99, 226, 135);">
            <p class="my-3">Witaj, {% raw %} {{ username }} {% endraw %} !!</p>
            <p class="my-3"> {% raw %} {{ players }} {% endraw %} gracz(y) online </p>
            <hr/>
            <div class="player-entry m-auto py-3 text-dark" style="cursor: pointer;" v-for="member in connectedPlayers"
              @click="choosePlayer">
              {% raw %} {{ member }} {% endraw %}
            </div>
          </div>
          <div class="w-100 communicate">KOMUNIKATY</div>
          <div class=" text-center py-3  w-100 h-25 statuses" @click="confirmSetup"
               style="cursor: pointer; background: #b6c0ca; font-size: 1em; font-weight: bold">

            {% raw %} {{ status }} {% endraw %}
          </div>
          <div class="w-100 communicate">ZAPROSZENIA</div>
          <div class="col h-75 text-center " style="background: rgb(99, 226, 135);">
            <div class="player-entry-invite  py-3 " style="cursor: pointer;" v-for="invitation in invitations">
              {% raw %} {{ invitation }} {% endraw %}
              <button class="buttonChoice" @click="acceptInvitation(invitation)">Akceptuj</button>
            <button class="buttonChoice" @click="declineInvitation(invitation)">Odrzuć</button>
            </div>
          </div>
        </div>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
      <script src="https://js.pusher.com/4.2/pusher.min.js"></script>
      <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
      <script>
      Pusher.logToConsole = true;
      var app = new Vue({

        el: '#app',

        data: {
          username: {{ name | tojson }},
          alphabet: {{ alphabet | tojson }},
          DESTROYED_SHIP: 1,
          MISSED: -1,
          EMPTY: 0,
          OCCUPIED: 2,
          players: 0,
          connectedPlayers: [],
          status: '',
          gameActive: false,
          respond: 3,
          pregame: false,
          playerNum: 2,
          opponentReady: false,
          invitations: [],
          pusher: new Pusher('4d2726b6eaed69e2834f', {
            authEndpoint: '/pusher/auth',
            cluster: 'eu',
            encrypted: true
          }),
          otherPlayerName: '',
          mychannel: {},
          otherPlayerChannel: {},
          turn: 0,
          gameResult: 0,
          mainBoxes: [
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0]
          ],
          yourBoxes: [
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0]
          ],
          clickedFrom: 0,
          ship4Len: 1,
          ship3Len: 2,
          ship2Len: 3,
          ship1Len: 4,
        },

        created() {
          this.subscribe();
          this.setupListeners();
        },

        methods: {
          subscribe: function () {
            let channel = this.pusher.subscribe('presence-channel');
            this.myChannel = this.pusher.subscribe('private-' + this.username);
            channel.bind('pusher:subscription_succeeded', (player) => {
              this.players = player.count - 1;
              player.each((player) => {
                if (player.id != this.username) {
                  this.connectedPlayers.push(player.id)
                }
              })
            })
            channel.bind('pusher:member_added', (player) => {
              this.players++
              this.connectedPlayers.push(player.id)
            })
            channel.bind('pusher:member_removed', (player) => {
              this.players--
              var index = this.connectedPlayers.indexOf(player.id);
              if (index > -1) {
                this.connectedPlayers.splice(index, 1)
              }
            })
          },

          setupListeners: function () {
            this.pusher.bind('client-' + this.username, (message) => {
              this.invitations.push(message)
            })

            this.myChannel.bind('client-game-declined', () => {
            })

            this.myChannel.bind('client-set-ships', (message) => {
              this.setShipsOnMap()
            })

            this.myChannel.bind('client-is-ready', (boxes) => {
              this.opponentReady = true;
              this.enemyBoxes = boxes
              console.log(this.enemyBoxes)
            })

            this.myChannel.bind('client-game-started', (message) => {
              this.status = "Zaczynasz bitwe. Twój ruch!"
              this.turn = 1
              this.pregame=false
            })

            this.myChannel.bind('client-shoot-on-position', (data) => {
              let yPos = data['yPos']
              let xPos = data['xPos']
              this.getValueOnPos(yPos, xPos);
              let field = document.getElementById("pos" + yPos + xPos)
              if(this.yourBoxes[yPos][xPos] == this.OCCUPIED) {
                this.yourBoxes[yPos][xPos] = this.DESTROYED_SHIP
                field.style.background = "red"
              } else {
                this.yourBoxes[yPos][xPos] = this.MISSED
                field.style.background = "orange"
              }
            })

            this.myChannel.bind('client-return-value', data => this.executePlayerAction(data))

            this.myChannel.bind('client-your-turn', () => {
              this.turn = 1
              this.status = "Twój ruch!"
            })

            this.myChannel.bind('client-ask-match', () => {
              if (this.areAllPlayerShipsDestroyed()) {
                this.gameLost()
                this.otherPlayerChannel.trigger('client-you-won', "")
              }
            })

            this.myChannel.bind('client-you-won', () => {
              this.gameWon();
            })
          },

          acceptInvitation: function(message) {
            console.log(message)
            if(this.gameActive == false) {
              this.otherPlayerName = message
              this.otherPlayerChannel = this.pusher.subscribe('private-' + this.otherPlayerName)
              this.otherPlayerChannel.bind('pusher:subscription_succeeded', () => {
                this.otherPlayerChannel.trigger('client-set-ships', message)
              })
              this.saveToDB()
              this.playerNum = 1
              const index = this.invitations.indexOf(message);
              if (index > -1) {
                this.invitations.splice(index, 1); // 2nd parameter means remove one item only
              }
              this.setShipsOnMap() //ETAP ROZSTAWIANIA STATKOW, DODAC WALIDACJE ROZSTAWIANIA I LIMITY
              this.gameActive = true
            }
          },

          declineInvitation: function(message) {
            console.log(message)
            this.otherPlayerChannel = this.pusher.subscribe('private-' + message)
            this.otherPlayerChannel.bind('pusher:subscription_succeeded', () => {
              this.otherPlayerChannel.trigger('client-game-declined', "")
            })
            const index = this.invitations.indexOf(message);
            if (index > -1) {
              this.invitations.splice(index, 1); // 2nd parameter means remove one item only
            }
            this.gameDeclined()
          },
          // Wyslanie zaproszenia do gry
          choosePlayer: function (e) {
            this.otherPlayerName = e.target.innerText
            this.otherPlayerChannel = this.pusher.subscribe('private-' + this.otherPlayerName)
            this.otherPlayerChannel.bind('pusher:subscription_succeeded', () => {
              this.otherPlayerChannel.trigger('client-' + this.otherPlayerName, this.username)
            });
          },

          // Gracz odmowil rozgrywki
          gameDeclined: function () {
          },

          // Set ships on the map
          setShipsOnMap: function () {
            this.status = "Ustaw statki na planszy. Kliknij tutaj, gdy bedziesz gotowy "
            this.pregame=true
          },

          executePlayerAction: function (data) {
            let yPos = data['yPos'];
            let xPos = data['xPos'];
            let value = data['value'];
            if (value == this.OCCUPIED) {
              this.mainBoxes[yPos][xPos] = this.DESTROYED_SHIP
              this.currentEvent.target.style.background = 'green'
              this.turn = 1
            } else {
              this.mainBoxes[yPos][xPos] = this.MISSED
              this.currentEvent.target.style.background = 'red'
              this.otherPlayerChannel.trigger('client-your-turn', "")
              this.status = "Ruch przeciwnika!"
            }
          },

          selectFrom: function(e) {
            let yPos = e.target.dataset.i
            let xPos = e.target.dataset.j
            this.clickedFrom = [e]
          },

          selectInRange: function(e) {
            if(this.clickedFrom !=0){
              let yPos = e.target.dataset.i
              let xPos = e.target.dataset.j
              console.log(yPos + ' ' + xPos)
              this.clickedFrom.push(e)

             }
          },

          selectTo: function(e) {
            if(this.clickedFrom !=0){
              let yPos = e.target.dataset.i
              let xPos = e.target.dataset.j
              this.clickedFrom.push(e)
              var clickedFields = this.clickedFrom.slice();
              clickedFields.shift()
              this.clickedFrom = 0
              if(clickedFields.length<5){
                var result =true
                for (let i = 0; i < clickedFields.length; i++){
                  result = this.settingAction(clickedFields[i], clickedFields.length);
                  if(result==false){
                    break
                  }
                }
                if(result==true){
                  if(clickedFields.length==4 && this.ship4Len!=0){
                    this.ship4Len = this.ship4Len-1
                    for (let i = 0; i < clickedFields.length; i++){
                      this.changeFieldToBlack(clickedFields[i])
                    }
                  }else if(clickedFields.length==3 && this.ship3Len!=0){
                    this.ship3Len = this.ship3Len-1
                    for (let i = 0; i < clickedFields.length; i++){
                      this.changeFieldToBlack(clickedFields[i])
                    }
                  }else if(clickedFields.length==2 && this.ship2Len!=0){
                    this.ship2Len = this.ship2Len-1
                    for (let i = 0; i < clickedFields.length; i++){
                      this.changeFieldToBlack(clickedFields[i])
                    }
                  }else if(clickedFields.length==1 && this.ship1Len!=0){
                    this.ship1Len = this.ship1Len-1
                    for (let i = 0; i < clickedFields.length; i++){
                      this.changeFieldToBlack(clickedFields[i])
                    }
                  }
                  else{
                    return 0
                  }
                }
              }
            }
          },

          // Ustawianie statkow + Dodac walidacje rozstawiania
          settingAction: function (e, len) {
            let yPos = e.target.dataset.i
            let xPos = e.target.dataset.j
            if(this.pregame==true){
              console.log(yPos + ' ' + xPos + " " + this.yourBoxes[yPos][xPos])
              if (this.yourBoxes[yPos][xPos] == this.EMPTY) {
                return true
              } else if (this.yourBoxes[yPos][xPos] == this.OCCUPIED && len==1) {
                this.yourBoxes[yPos][xPos] = this.EMPTY
                e.target.style.background = 'rgb(171, 212, 248)'
              }else{
                return false
              }
            }
          },

          changeFieldToBlack: function(e){
            let yPos = e.target.dataset.i
            let xPos = e.target.dataset.j
            this.yourBoxes[yPos][xPos] = this.OCCUPIED
            e.target.style.background = 'black'
          },

          // Potwierdz ulozenie planszy
          confirmSetup: function (e) {
            if(this.pregame == true) {
              if (this.opponentReady == false) {
                this.otherPlayerChannel.trigger('client-is-ready', this.yourBoxes)
                this.status = "Oczekiwanie na przeciwnika"
              } else {
                this.startGame()
                this.otherPlayerChannel.trigger('client-game-started', "")
              }
            }
          },

          // rozpoczecie gry
          startGame: function () {
            this.status = "Gra rozpoczęta";
            this.pregame=false
          },

          // Checks to see if the play was a winning play CHECK IF IT IS WORKING
          async playerAction(e) {
            this.currentEvent = e
            let yPos = e.target.dataset.i
            let xPos = e.target.dataset.j

            if (this.turn && this.mainBoxes[yPos][xPos] == this.EMPTY) {
              this.turn = 0
              console.log(yPos + " " + xPos)

              this.otherPlayerChannel.trigger('client-shoot-on-position', {
                "yPos": yPos,
                "xPos": xPos
              })

              this.otherPlayerChannel.trigger('client-ask-match', "")
            }
          },

          getValueOnPos: function (yPos, xPos) {
            this.otherPlayerChannel.trigger('client-return-value', {
              "yPos": yPos,
              "xPos": xPos,
              "value": this.yourBoxes[yPos][xPos]
            })
          },

          // sprawdza, czy wszystkie statki zostaly znalezione
          areAllPlayerShipsDestroyed: function () {
            for (var i = 0; i < 8; i++) {
              for (var j = 0; j < 8; j++) {
                if (this.yourBoxes[i][j] == this.OCCUPIED) {
                  return false
                }
              }
            }
            return true
          },

          // Obecny gracz wygrywa
          gameWon: function () {
            this.status = "Wygrałeś!"
            this.gameResult = 1
            this.updateStatusGameToDB()
          },

          // Obecny gracz przegrywa
          gameLost: function () {
            this.status = "Przegrałeś!"
            this.gameResult = 2
          },

          restartGame: function () {
            this.gameActive = false
            this.$refs.gameboard_main.classList.add('invisible');
            this.$refs.gameboard.classList.add('invisible');
            for (i = 0; i < 8; i++) {
              for (j = 0; j < 8; j++) {
                this.mainBoxes[i][j] = this.EMPTY;
                this.yourBoxes[i][j] = this.EMPTY
              }
            }
            this.$refs.gameboard_main.classList.remove('invisible');
            this.$refs.gameboard.classList.remove('invisible');
          },

          async saveToDB(){
            var config = { headers: {'Content-Type': 'application/json'}}
            const path = '/rooms';
            await axios.post(path,{
              gameResult: this.gameResult,
              enemy: this.otherPlayerName,
            },config)
            .then(response => {
                console.log(response)
            })
            .catch(error => {
                console.log(error.response)
            });
          },

          async updateStatusGameToDB(){
            var config = { headers: {'Content-Type': 'application/json'}}
            const path = '/rooms';
            await axios.put(path,{
              playerNum: this.playerNum,
            },config)
            .then(response => {
                console.log(response)
            })
            .catch(error => {
                console.log(error.response)
            });
          },
        }
     });
    </script>

  </div>
</div>
{% endblock %}